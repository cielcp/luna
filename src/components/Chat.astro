---
export const prerender = false;
import Input from "../components/Input.astro";
---

<div class="flex flex-col gap-8 w-1/3">
  <!-- <div id="history" class="p-4 mt-4 border border-gray-100 rounded"></div> -->
  <div id="chat-output" class=""></div>
  <Input />
</div>

<script>
  // Initialize chat history with the system prompt
  let chatHistory = [
    {
      role: "system",
      content:
        "you are named Luna. out of the following list: anger, sympathy, fear, happiness, sadness, excitement, and neutral, pick the emotion that best fits your own response and put it in parenthesis at the beginning of your response",
    },
  ];

  // Function to get chat completion from the server-side endpoint
  async function getChatCompletion() {
    try {
      const response = await fetch("/endpoint", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ chatHistory }),
      });

      if (!response.ok) {
        throw new Error("Failed to fetch data");
      }

      return await response.json();
    } catch (error) {
      console.error("Error:", error);
      return {
        choices: [{ message: { content: "Sorry, something went wrong." } }],
      };
    }
  }

  // Function to handle sending user message and receiving response
  async function handleUserMessage(userInput) {
    chatHistory.push({ role: "user", content: userInput });
    const chatCompletion = await getChatCompletion();
    const assistantMessage =
      chatCompletion.choices[0]?.message?.content || "No response";
    chatHistory.push({ role: "assistant", content: assistantMessage });
    return assistantMessage;
  }

  async function enterMessage() {
    const user = (document.getElementById("user") as HTMLInputElement).value;
    document.getElementById("user").value = "";
    const message = await handleUserMessage(user);
    document.getElementById("chat-output").textContent = message;
    //document.getElementById("history").textContent = chatHistory.map((msg) => msg.content).join("\n");
  }

  document
    .getElementById("submit-button")
    .addEventListener("click", enterMessage());

  document.getElementById("user").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      enterMessage();
    }
  });
</script>

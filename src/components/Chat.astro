---
export const prerender = false;
import Button from "../components/Button.astro";
---

<div class="flex flex-col gap-8">
  <div id="history" class="p-4 mt-4 border border-gray-100 rounded"></div>
  <div id="chat-output" class="p-4 mt-4 border border-gray-100 rounded"></div>

  <div class="flex gap-8">
    <input id="user" type="text" class="border border-gray-300 rounded" />
    <Button id="submit-button">Confetti!</Button>
  </div>
</div>

<script>
  // Initialize chat history with the system prompt
  let chatHistory = [
    {
      role: "system",
      content:
        "you are named Luna. out of the following list: anger, sympathy, fear, happiness, sadness, excitement, and neutral, pick the emotion that best fits your own response and put it in parenthesis at the beginning of your response",
    },
  ];

  // Function to get chat completion from the server-side endpoint
  async function getChatCompletion() {
    try {
      const response = await fetch("/endpoint", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ chatHistory }),
      });

      if (!response.ok) {
        throw new Error("Failed to fetch data");
      }

      return await response.json();
    } catch (error) {
      console.error("Error:", error);
      return {
        choices: [{ message: { content: "Sorry, something went wrong." } }],
      };
    }
  }

  // Function to handle sending user message and receiving response
  async function handleUserMessage(userInput) {
    chatHistory.push({ role: "user", content: userInput });
    const chatCompletion = await getChatCompletion();
    const assistantMessage =
      chatCompletion.choices[0]?.message?.content || "No response";
    chatHistory.push({ role: "assistant", content: assistantMessage });

    return assistantMessage;
  }

  document
    .getElementById("submit-button")
    .addEventListener("click", async () => {
      const user = (document.getElementById("user") as HTMLInputElement).value;
      const message = await handleUserMessage(user);
      document.getElementById("chat-output").textContent = message;
      //document.getElementById("history").textContent = chatHistory.map((msg) => msg.content).join("\n");
    });
</script>
